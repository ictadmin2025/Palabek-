const GS_SESSION_ID="uid-"+Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,11);function sanitizeJSONString(e){return"string"!=typeof e?e:e.replace(/[\u0000-\u001F\u007F-\u009F]/g,"")}function GSrunAPICall(e){if("string"==typeof e&&(e=JSON.parse(e)),!e)return;function t(e,t){if(!t)return e;let r=t.match(/(\w+)|\[(\d+)\]/g);if(r)return r.reduce((e,t)=>(t=t.replace(/[\[\]]/g,""),e?e[t]:void 0),e)}let r=[{regex:/\{\{TEXT:(.*?)\}\}/g,handler(e){let t=document.querySelector(e);return t&&t.innerText?t.innerText:""}},{regex:/\{\{URL:(.*?)\}\}/g,handler(e){let t=document.querySelector(e);if(t){let r=t.getAttribute("href");return r||(r=t.getAttribute("src")),r}return""}},{regex:/\{\{VALUE:(.*?)\}\}/g,handler(e){let t=document.querySelector(e);return t&&t.value?t.value:""}},{regex:/\{\{COOKIE:(.*?)\}\}/g,handler(e){let t;return GSCookClass.getCookie(e)||""}},{regex:/\{\{STORAGE:(.*?)\}\}/g,handler(e){let t;return localStorage.getItem(e)||""}},{regex:/\{\{ATTR:(.*?)\}\}/g,handler(e){let t=e.split("|").map(e=>e.trim());if(2===t.length){let r=t[0],a=document.querySelector(t[1]);return a&&a.getAttribute(r)||""}return""}},{regex:/\{\{FORMDATA:(.*?)\}\}/g,handler(e){let t=document.querySelector(e);if(t){let r=new FormData(t),a={};return r.forEach((e,t)=>{a[t]=e}),JSON.stringify(a)}return""}},{regex:/\{\{SESSION_ID\}\}/g,handler:()=>GS_SESSION_ID}],a=e=>{if("string"!=typeof e)return e;let t=e;for(let{regex:a,handler:l}of r)t=t.replace(a,(e,t)=>l(t));return t},l=(e,t=!1)=>{if("string"!=typeof e)return e;let r=[],a=[],l=e.replace(/```([\s\S]*?)```/gim,function(e,t){let a=t,l="",i=a.match(/^([a-zA-Z0-9_+-]+)\s*\n/);return i&&(l=i[1].toLowerCase(),a=a.substring(i[0].length)),r.push({content:a,language:l}),"CODE_BLOCK_PLACEHOLDER_"+(r.length-1)});l=(l=(l=(l=(l=(l=(l=(l=l.replace(/`(.*?)`/gim,function(e,t){return a.push(t),"INLINE_CODE_PLACEHOLDER_"+(a.length-1)})).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")).replace(/^#### (.*$)/gim,"<h4>$1</h4>")).replace(/^### (.*$)/gim,"<h3>$1</h3>")).replace(/^## (.*$)/gim,"<h2>$1</h2>")).replace(/^# (.*$)/gim,"<h1>$1</h1>")).replace(/\*\*(.*?)\*\*/gim,"<strong>$1</strong>")).replace(/\*(.*?)\*/gim,"<em>$1</em>");let i=!1,n="",s=l.split("\n");for(let o=0;o<s.length;o++){let c=s[o].match(/^\s*[\*\-] (.*)/),d=s[o].match(/^\s*(\d+)\. (.*)/);c?i&&"ul"===n?s[o]="<li>"+c[1]+"</li>":(i?s[o]="</"+n+"><ul><li>"+c[1]+"</li>":s[o]="<ul><li>"+c[1]+"</li>",i=!0,n="ul"):d?i&&"ul"===n?s[o]="<li>"+d[2]+"</li>":(i?s[o]="</"+n+"><ul><li>"+d[2]+"</li>":s[o]="<ul><li>"+d[2]+"</li>",i=!0,n="ul"):i&&""===s[o].trim()?(s[o]="</"+n+">",i=!1):i&&""!==s[o].trim()&&(s[o-1]=s[o-1].replace(/<\/li>$/," "+s[o]+"</li>"),s[o]="")}return i&&s.push("</"+n+">"),l=(l=s.join("\n")).replace(/\[(.*?)\]\((.*?)\)/gim,'<a href="$2">$1</a>'),t||(l=l.replace(/^(?!\s*<\/?(?:ul|ol|li|h\d|blockquote|pre|img|code))[^\n<]+(?:\n(?!\s*<\/?(?:ul|ol|li|h\d|blockquote|pre|img|code))[^\n<]+)*/gim,function(e){return""===e.trim()?"":"<p>"+e+"</p>"})),l=(l=(l=(l=(l=(l=(l=l.replace(/\n(?!\s*<\/?(?:p|ul|ol|li|h\d|blockquote|pre|code))/gim,"<br>")).replace(/<p>\s*<\/p>/gim,"")).replace(/CODE_BLOCK_PLACEHOLDER_(\d+)/g,function(e,t){let a=r[parseInt(t)],l=a.content,i=a.language;return(l=l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),i)?'<div class="code_language">'+i+"</div><pre><code>"+l+"</code></pre>":"<pre><code>"+l+"</code></pre>"})).replace(/INLINE_CODE_PLACEHOLDER_(\d+)/g,function(e,t){let r=a[parseInt(t)];return"<code>"+(r=r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"))+"</code>"})).replace(/(<br>\s*)+/g,"<br>")).replace(/^\s*<br>/g,"")).replace(/<br>\s*$/g,"")},{result_selector:i,result_handle:n="replace",loader_selector:s,apiHeaders:o,apiUrl:c,apiMethod:d,apiBody:u,responseField:g,appendField:p,assistantField:f,user_message:h,assistant_message:m,custom_response:L,responseMaps:S,response_selector:b,repeatable:A,stream_chat:v=!1,stream_response:y=!1,no_data_text:E="No data found"}=e,$=Array.isArray(o)?o.reduce((e,t)=>(t.name&&(e[t.name]=a(t.value)),e),{}):{},_=s?document.querySelector(s):null;_&&_.classList.add("active");let O=i?document.querySelector(i):null;O&&(O.classList.remove("loaded"),O.classList.remove("active"),O.classList.add("loading"));let T="gspb-api-saved-var";g&&(T=g.replace(/[^a-zA-Z0-9]/g,""));let w=(e,r,a)=>{if(r&&e){let l=JSON.parse(e),i=t(l,r);i&&(Array.isArray(i)?i.push(a):l[r]=a),e=JSON.stringify(l)}return e},q=u?a(u):null;v&&void 0!==window[T]&&(q=window[T]);let N=h?a(h):null;N&&(q=w(q,p,JSON.parse(a(N))));let H=a(c);H.includes("greenshift/v1/proxy-api")&&"undefined"!=typeof gspbApiSettings&&($["X-WP-Nonce"]=gspbApiSettings.nonce),fetch(H,{method:d||"GET",headers:$,body:q}).then(e=>{if(y){if(!e.ok)throw Error(`HTTP error! Status: ${e.status}`);if(!e.body)throw Error("ReadableStream not supported in this browser.");let r=e.body.getReader(),a="",i=new TextDecoder,s=null;O&&("replace"===n&&(O.innerHTML=""),(s=document.createElement("div")).classList.add("gs-streaming-content"),"append"===n?O.appendChild(s):"prepend"===n?O.insertBefore(s,O.firstChild):O.appendChild(s));let o="",c=()=>r.read().then(({done:e,value:r})=>{if(e){s&&!s.classList.contains("result-loaded")&&s.classList.add("result-loaded");return}let l=i.decode(r,{stream:!0});a+=l;let n;if(L&&S&&b&&!s.hasAttribute("data-initialized")){let u=document.querySelector(b);u&&(s.innerHTML=u.innerHTML,s.setAttribute("data-initialized","true"))}let p=!s.hasAttribute("data-received-first-chunk");for(;-1!==(n=a.indexOf("\n"));){let h=a.slice(0,n).trim();if(a=a.slice(n+1),h&&s)try{if("data: [DONE]"===h){console.log("Stream completed"),s.classList.add("result-loaded");continue}let A=h.startsWith("data: ")?h.substring(6):h,v=JSON.parse(A),y=g?t(v,g):v;if(p&&_&&(_.classList.remove("active"),s.setAttribute("data-received-first-chunk","true"),p=!1),L&&S&&b){if(d(y),f&&m){let E=t(y,f);E&&(o+=E)}}else"string"==typeof y?(y=y.replace(/<\/?p>/g,""),s.innerHTML+=y):null!=y&&(s.innerHTML+=String(y)),s.classList.remove("loading"),s.classList.add("loaded"),s.classList.add("active"),m&&(o+=y)}catch($){console.error("Error parsing stream chunk:",$)}}return c()}),d=e=>{if(!L||!S||!b)return e;let r={};return S.forEach(a=>{let i=a.name,n=t(e,a.value);r[i]||(r[i]=s.querySelector(i));let o=r[i];if(o&&!o.classList.contains("loaded")&&o.classList.add("loading"),void 0!==n&&o){if("date"===a.format&&(n=new Date(n).toLocaleString()),"markdown"===a.format&&"string"==typeof n){o.hasAttribute("data-raw-content")||o.setAttribute("data-raw-content","");let c=o.getAttribute("data-raw-content");c+=n,o.setAttribute("data-raw-content",c),o.innerHTML=l(c,!0)}else o.hasAttribute("src")?o.setAttribute("src",n):o.hasAttribute("href")?o.setAttribute("href",n):("string"==typeof n&&(n=n.replace(/<\/?p>/g,"")),o.innerHTML+=n);o.classList.contains("loaded")||(o.classList.remove("loading"),o.classList.add("loaded"),o.classList.add("active"))}}),null};return c().catch(e=>{throw console.error("Stream error:",e),e}).finally(()=>{if(O){O.classList.remove("loading"),setTimeout(()=>{O.classList.add("loaded"),O.classList.add("active")},50);let e=O.getAttribute("data-nextrun");if(e){let t=parseInt(e);O.setAttribute("data-nextrun",t+1)}else O.setAttribute("data-nextrun",2);s&&S&&S.forEach(e=>{if("markdown"===e.format){let t=s.querySelector(e.name);if(t&&t.hasAttribute("data-raw-content")){let r=t.getAttribute("data-raw-content");t.innerHTML=l(r,!0),t.removeAttribute("data-raw-content")}}})}if(q&&p&&o&&f&&m){let r=m.replace("{{RESPONSE}}",o);try{let a=sanitizeJSONString(r),i=JSON.parse(a);q=w(q,p,i),window[T]=q}catch(n){console.error("Error parsing assistant message JSON:",n),console.log("Problematic JSON string:",r)}}if(O){let c=O.querySelectorAll("[data-gspbactions]");c.length>0&&"function"==typeof GSPB_Trigger_Actions&&GSPB_Trigger_Actions("front",c),"undefined"!=typeof GSChartRun&&GSChartRun(O),document.dispatchEvent(new CustomEvent("GSPB_API_RESPONSE",{detail:{resultElem:O,responseData:null}}))}})}return e.json()}).then(e=>{if(y)return;let r=g?t(e,g):e,a=r;if(f&&r&&q&&p&&m){let i=t(r,f),s=m.replace("{{RESPONSE}}",i);try{let o=sanitizeJSONString(s),c=JSON.parse(o);q=w(q,p,c),window[T]=q}catch(d){console.error("Error parsing assistant message JSON:",d),console.log("Problematic JSON string:",s)}}else window[T]=a;if(void 0===a&&(a='<div class="gspb-api-noresponse">'+E+"</div>"),L&&S&&b){let u=document.querySelector(b),h="",v=[];if(u){let $=e=>{let r=u.cloneNode(!0);return S.forEach(a=>{let i=a.name,n=r.querySelector(i);n.classList.add("loading");let s=t(e,a.value);void 0===s&&v.push(a.name),n&&("date"===a.format&&(s=new Date(s).toLocaleString()),"markdown"===a.format&&"string"==typeof s&&(s=l(s)),n.hasAttribute("src")?n.setAttribute("src",s):n.hasAttribute("href")?n.setAttribute("href",s):n.innerHTML=s,n.classList.remove("loading"),n.classList.add("loaded"),n.classList.add("active"))}),r.innerHTML};A&&Array.isArray(a)?a.forEach(e=>{h+=$(e)}):h=$(a),h&&(a=h),v.length>0&&v.length===S.length&&(a='<div class="gspb-api-noresponse">'+E+"</div>")}}if(O){"replace"===n?O.innerHTML=a:"append"===n?O.innerHTML+=a:"prepend"===n&&(O.innerHTML=a+O.innerHTML),Array.from(O.children).forEach(e=>{e.classList.contains("result-loaded")||setTimeout(()=>{e.classList.add("result-loaded")},10)});let _=O.querySelectorAll("[data-gspbactions]");_.length>0&&"function"==typeof GSPB_Trigger_Actions&&GSPB_Trigger_Actions("front",_),"undefined"!=typeof GSChartRun&&GSChartRun(O),document.dispatchEvent(new CustomEvent("GSPB_API_RESPONSE",{detail:{resultElem:O,responseData:r}}))}}).catch(e=>{console.error("Fetch error:",e)}).finally(()=>{if(!y){if(_&&_.classList.remove("active"),O){O.classList.remove("loading"),setTimeout(()=>{O.classList.add("loaded"),O.classList.add("active")},50);let e=O.getAttribute("data-nextrun");if(e){let t=parseInt(e);O.setAttribute("data-nextrun",t+1)}else O.setAttribute("data-nextrun",2)}O&&O.querySelector(".gspb-api-noresponse")&&setTimeout(()=>{O.querySelector(".gspb-api-noresponse").remove()},1e3)}})}